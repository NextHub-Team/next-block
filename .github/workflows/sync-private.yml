name: sync-private-repo
on:
  push:
    branches: [main]
  workflow_dispatch: {}

jobs:
  mirror:
    runs-on: ubuntu-latest
    env:
      TARGET_REPO_PAT: ${{ secrets.PRIVATE_VERO_REPO_TOKEN }}
      TARGET_REPO_URL: ${{ secrets.PRIVATE_VERO_REPO_URL }}
    steps:
      - name: Check for target PAT
        id: secret-check
        run: |
          if [ -z "${TARGET_REPO_PAT}" ]; then
            echo "missing=true" >> "$GITHUB_OUTPUT"
            echo "::notice title=Mirror skipped::PRIVATE_VERO_REPO_TOKEN is not set; skipping sync. This is expected on forks or environments without access to the secret."
            exit 0
          fi

          if [ -z "${TARGET_REPO_URL}" ]; then
            echo "missing=true" >> "$GITHUB_OUTPUT"
            echo "::notice title=Mirror skipped::PRIVATE_VERO_REPO_URL is not set; provide the full https URL to the private repo (e.g., https://github.com/your-org/your-repo.git)."
            exit 0
          fi

          echo "missing=false" >> "$GITHUB_OUTPUT"

      # 1. Check out latest public main
      - uses: actions/checkout@v4
        if: steps.secret-check.outputs.missing == 'false'
        with:
          fetch-depth: 0
          token: ${{ secrets.PRIVATE_VERO_REPO_TOKEN }}

      # 2. Rewrite commit author and remote info to hide origin
      - name: Prepare anonymous mirror
        if: steps.secret-check.outputs.missing == 'false'
        run: |
          git remote remove origin || true
          git remote add target "${TARGET_REPO_URL/https:\/\///x-access-token:${TARGET_REPO_PAT}@}"

      - name: Verify access to target repository
        if: steps.secret-check.outputs.missing == 'false'
        run: git ls-remote --exit-code target

      # 3. Push as plain code snapshot
      - name: Push to private repository
        if: steps.secret-check.outputs.missing == 'false'
        run: |
          # Create a detached copy of main tree as a new commit
          git switch --detach
          SNAPSHOT_BRANCH="sync-$(date +%Y%m%d%H%M%S)"
          git checkout -b "$SNAPSHOT_BRANCH"
          git commit --allow-empty -m "Automated build sync"
          git push --force-with-lease target HEAD:refs/heads/main
