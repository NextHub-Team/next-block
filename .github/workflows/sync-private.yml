name: sync-private-repo
on:
  push:
    branches: [main]
  workflow_dispatch: {}

jobs:
  mirror:
    runs-on: ubuntu-latest
    env:
      TARGET_REPO_PAT: ${{ secrets.PRIVATE_VERO_REPO_TOKEN }}
    steps:
      - name: Check for target PAT
        id: secret-check
        run: |
          if [ -z "${TARGET_REPO_PAT}" ]; then
            echo "missing=true" >> "$GITHUB_OUTPUT"
            echo "::notice title=Mirror skipped::PRIVATE_VERO_REPO_TOKEN is not set; skipping sync. This is expected on forks or environments without access to the secret."
            exit 0
          fi
          echo "missing=false" >> "$GITHUB_OUTPUT"

      # 1. Check out latest public main
      - uses: actions/checkout@v4
        if: steps.secret-check.outputs.missing == 'false'
        with:
          fetch-depth: 0

      # 2. Rewrite commit author and remote info to hide origin
      - name: Prepare anonymous mirror
        if: steps.secret-check.outputs.missing == 'false'
        run: |
          git config user.name  "build-sync"
          git config user.email "build-sync@users.noreply.github.com"
          git remote remove origin
          git remote add target "https://x-access-token:${TARGET_REPO_PAT}@github.com/Metapolitanltd/VaultBackend.git"

      - name: Verify access to target repository
        if: steps.secret-check.outputs.missing == 'false'
        run: git ls-remote --exit-code target

      # 3. Push as plain code snapshot
      - name: Push to private repository
        if: steps.secret-check.outputs.missing == 'false'
        run: |
          # Create a detached copy of main tree as a new commit
          git switch --detach
          SNAPSHOT_BRANCH="sync-$(date +%Y%m%d%H%M%S)"
          git checkout -b "$SNAPSHOT_BRANCH"
          git commit --allow-empty -m "Automated build sync"
          git push --force-with-lease target HEAD:refs/heads/main
